import d,{createContext as ae,createRef as se,useContext as V,useEffect as L,useMemo as h,useReducer as pe,useRef as _,useState as de}from"react";import{match as w}from"../../utils/match.js";import{forwardRefWithAs as v,render as A,Features as K}from"../../utils/render.js";import{useSyncRefs as E}from"../../hooks/use-sync-refs.js";import{Keys as ue}from"../keyboard.js";import{isDisabledReactIssue7711 as fe}from"../../utils/bugs.js";import{useId as b}from"../../hooks/use-id.js";import{FocusTrap as C}from"../../components/focus-trap/focus-trap.js";import{useInertOthers as ge}from"../../hooks/use-inert-others.js";import{Portal as I}from"../../components/portal/portal.js";import{ForcePortalRoot as x}from"../../internal/portal-force-root.js";import{Description as ce,useDescriptions as Te}from"../description/description.js";import{useOpenClosed as me,State as q}from"../../internal/open-closed.js";import{useServerHandoffComplete as De}from"../../hooks/use-server-handoff-complete.js";import{StackProvider as Pe,StackMessage as z}from"../../internal/stack-context.js";import{useOutsideClick as ye,Features as Re}from"../../hooks/use-outside-click.js";import{getOwnerDocument as he}from"../../utils/owner.js";import{useOwnerDocument as ve}from"../../hooks/use-owner.js";import{useEventListener as Ae}from"../../hooks/use-event-listener.js";import{Hidden as Ee,Features as be}from"../../internal/hidden.js";import{useEvent as k}from"../../hooks/use-event.js";var Ce=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(Ce||{}),Oe=(e=>(e[e.SetTitleId=0]="SetTitleId",e))(Oe||{});let Se={[0](a,e){return a.titleId===e.id?a:{...a,titleId:e.id}}},M=ae(null);M.displayName="DialogContext";function O(a){let e=V(M);if(e===null){let o=new Error(`<${a} /> is missing a parent <Dialog /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,O),o}return e}function Fe(a,e){return w(e.type,Se,a,e)}let Le="div",we=K.RenderStrategy|K.Static,ke=v(function(e,o){let{open:r,onClose:n,initialFocus:p,__demoMode:g=!1,...c}=e,[m,D]=de(0),S=me();r===void 0&&S!==null&&(r=w(S,{[q.Open]:!0,[q.Closed]:!1}));let u=_(new Set),f=_(null),J=E(f,o),H=_(null),P=ve(f),W=e.hasOwnProperty("open")||S!==null,B=e.hasOwnProperty("onClose");if(!W&&!B)throw new Error("You have to provide an `open` and an `onClose` prop to the `Dialog` component.");if(!W)throw new Error("You provided an `onClose` prop to the `Dialog`, but forgot an `open` prop.");if(!B)throw new Error("You provided an `open` prop to the `Dialog`, but forgot an `onClose` prop.");if(typeof r!="boolean")throw new Error(`You provided an \`open\` prop to the \`Dialog\`, but the value is not a boolean. Received: ${r}`);if(typeof n!="function")throw new Error(`You provided an \`onClose\` prop to the \`Dialog\`, but the value is not a function. Received: ${n}`);let i=r?0:1,[y,Q]=pe(Fe,{titleId:null,descriptionId:null,panelRef:se()}),R=k(()=>n(!1)),G=k(t=>Q({type:0,id:t})),U=De()?g?!1:i===0:!1,F=m>1,$=V(M)!==null,X=F?"parent":"leaf";ge(f,F?U:!1),ye(()=>{var l,s;return[...Array.from((l=P==null?void 0:P.querySelectorAll("body > *"))!=null?l:[]).filter(T=>!(!(T instanceof HTMLElement)||T.contains(H.current)||y.panelRef.current&&T.contains(y.panelRef.current))),(s=y.panelRef.current)!=null?s:f.current]},()=>{i===0&&(F||R())},Re.IgnoreScrollbars),Ae(P==null?void 0:P.defaultView,"keydown",t=>{t.defaultPrevented||t.key===ue.Escape&&i===0&&(F||(t.preventDefault(),t.stopPropagation(),R()))}),L(()=>{var j;if(i!==0||$)return;let t=he(f);if(!t)return;let l=t.documentElement,s=(j=t.defaultView)!=null?j:window,T=l.style.overflow,le=l.style.paddingRight,Y=s.innerWidth-l.clientWidth;if(l.style.overflow="hidden",Y>0){let ne=l.clientWidth-l.offsetWidth,ie=Y-ne;l.style.paddingRight=`${ie}px`}return()=>{l.style.overflow=T,l.style.paddingRight=le}},[i,$]),L(()=>{if(i!==0||!f.current)return;let t=new IntersectionObserver(l=>{for(let s of l)s.boundingClientRect.x===0&&s.boundingClientRect.y===0&&s.boundingClientRect.width===0&&s.boundingClientRect.height===0&&R()});return t.observe(f.current),()=>t.disconnect()},[i,f,R]);let[Z,ee]=Te(),te=`headlessui-dialog-${b()}`,oe=h(()=>[{dialogState:i,close:R,setTitleId:G},y],[i,y,R,G]),N=h(()=>({open:i===0}),[i]),re={ref:J,id:te,role:"dialog","aria-modal":i===0?!0:void 0,"aria-labelledby":y.titleId,"aria-describedby":Z,onClick(t){t.stopPropagation()}};return d.createElement(Pe,{type:"Dialog",element:f,onUpdate:k((t,l,s)=>{l==="Dialog"&&w(t,{[z.Add](){u.current.add(s),D(T=>T+1)},[z.Remove](){u.current.add(s),D(T=>T-1)}})})},d.createElement(x,{force:!0},d.createElement(I,null,d.createElement(M.Provider,{value:oe},d.createElement(I.Group,{target:f},d.createElement(x,{force:!1},d.createElement(ee,{slot:N,name:"Dialog.Description"},d.createElement(C,{initialFocus:p,containers:u,features:U?w(X,{parent:C.features.RestoreFocus,leaf:C.features.All&~C.features.FocusLock}):C.features.None},A({ourProps:re,theirProps:c,slot:N,defaultTag:Le,features:we,visible:i===0,name:"Dialog"})))))))),d.createElement(Ee,{features:be.Hidden,ref:H}))}),Me="div",_e=v(function(e,o){let[{dialogState:r,close:n}]=O("Dialog.Overlay"),p=E(o),g=`headlessui-dialog-overlay-${b()}`,c=k(u=>{if(u.target===u.currentTarget){if(fe(u.currentTarget))return u.preventDefault();u.preventDefault(),u.stopPropagation(),n()}}),m=h(()=>({open:r===0}),[r]);return A({ourProps:{ref:p,id:g,"aria-hidden":!0,onClick:c},theirProps:e,slot:m,defaultTag:Me,name:"Dialog.Overlay"})}),Ie="div",xe=v(function(e,o){let[{dialogState:r},n]=O("Dialog.Backdrop"),p=E(o),g=`headlessui-dialog-backdrop-${b()}`;L(()=>{if(n.panelRef.current===null)throw new Error("A <Dialog.Backdrop /> component is being used, but a <Dialog.Panel /> component is missing.")},[n.panelRef]);let c=h(()=>({open:r===0}),[r]);return d.createElement(x,{force:!0},d.createElement(I,null,A({ourProps:{ref:p,id:g,"aria-hidden":!0},theirProps:e,slot:c,defaultTag:Ie,name:"Dialog.Backdrop"})))}),He="div",We=v(function(e,o){let[{dialogState:r},n]=O("Dialog.Panel"),p=E(o,n.panelRef),g=`headlessui-dialog-panel-${b()}`,c=h(()=>({open:r===0}),[r]);return A({ourProps:{ref:p,id:g},theirProps:e,slot:c,defaultTag:He,name:"Dialog.Panel"})}),Be="h2",Ge=v(function(e,o){let[{dialogState:r,setTitleId:n}]=O("Dialog.Title"),p=`headlessui-dialog-title-${b()}`,g=E(o);L(()=>(n(p),()=>n(null)),[p,n]);let c=h(()=>({open:r===0}),[r]);return A({ourProps:{ref:g,id:p},theirProps:e,slot:c,defaultTag:Be,name:"Dialog.Title"})}),Dt=Object.assign(ke,{Backdrop:xe,Panel:We,Overlay:_e,Title:Ge,Description:ce});export{Dt as Dialog};
